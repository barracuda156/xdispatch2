---
kind: pipeline
type: docker
name: pre-commit

steps:
- name: check hooks
  image: ${MZ_DOCKER_REGISTRY}/pre-commit:latest
  commands:
    - pre-commit run --all-files --verbose --show-diff-on-failure


---
kind: pipeline
type: docker
name: ubuntu-1604-clang

steps:
- name: submodules
  image: alpine/git
  commands:
    - git fetch --tags
    - git submodule update --init --recursive

- name: build
  image: ${MZ_DOCKER_REGISTRY}/builder-1604-cache:latest
  commands:
    - cd build
    - bash ./generator.sh mode=release compiler=clang generator=ninja location=inside -DBUILD_XDISPATCH2_TESTS=ON
    - cd clang-ninja-release
    - ninja -j 12

- name: test
  image: ${MZ_DOCKER_REGISTRY}/builder-1604-cache:latest
  environment:
    USER: test_runner
    # XDISPATCH2_TRACE: 1
  commands:
    - cd build/clang-ninja-release/bin
    - ./xdispatch2_tests

---
kind: pipeline
type: exec
name: darwin-macos

platform:
  os: darwin
  arch: amd64

steps:
- name: submodules
  commands:
    - git fetch --tags
    - git submodule update --init --recursive

- name: build
  commands:
    - ln -s /Users/$${USER}/Library $${HOME}/Library
    - cd build
    - bash ./generator.sh mode=release compiler=clang generator=ninja location=inside -DBUILD_XDISPATCH2_TESTS=ON
    - cd clang-ninja-release
    - ninja -j 12

- name: test
  environment:
    # XDISPATCH2_TRACE: 1
  commands:
    - cd build/clang-ninja-release/bin
    - ./xdispatch2_tests


---
kind: pipeline
type: exec
name: darwin-ios

platform:
  os: darwin
  arch: amd64

steps:
- name: submodules
  commands:
    - git fetch --tags
    - git submodule update --init --recursive

- name: build
  commands:
    - ln -s /Users/$${USER}/Library $${HOME}/Library
    - cd build
    - bash ./generator.sh mode=release compiler=ios generator=makefiles location=inside -DBUILD_XDISPATCH2_TESTS=ON
    - cd ios-makefiles-release
    - make -j 12


---
kind: pipeline
type: exec
name: windows-msvc64

platform:
  os: windows
  arch: amd64

steps:
- name: submodules
  commands:
    - git fetch --tags
    - git submodule update --init --recursive

- name: build
  commands:
    - cd build
    - .\generator.bat release ninja_64 inside '"-DBUILD_XDISPATCH2_TESTS=ON"'
    - cd win32-ninja_64-release
    - ninja

- name: test
  environment:
    # XDISPATCH2_TRACE: 1
  commands:
    - cd build/win32-ninja_64-release/bin
    - .\xdispatch2_tests.exe
